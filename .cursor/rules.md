# Общие архитектурные правила проекта eye_w

Этот файл дополняет правила в `.cursor/rules/*.mdc`. Backend — FastAPI + SQLAlchemy (папка `backend/app`). Слой Django удалён из репозитория.

## 1. Стек и границы

- **Backend**: FastAPI + SQLAlchemy (`backend/app`) — эндпоинты и модели не менять без плана и обновления документации.
- **Форма оператора**: источник данных (`OrderCreate`); поля не менять без обновления `PROJECT_CONTEXT.md` и `DevelopmentDiary.md`.
- **Docx**: генерация документов через существующий `docx_service` и `PLACEHOLDER_TO_FIELD`.

## 2. Статусы и бизнес-правила

- Статусы документа разделены:
  - финансовый статус — по сумме платежей и `total_amount` (UNPAID, PARTIALLY_PAID, FULLY_PAID, OVERPAID);
  - операционный статус — жизненный цикл документа.
- Менять статусы только через сервисный слой с проверками и инвариантами, не вручную и не в роутерах.

## 3. Запрет бизнес-логики в роутерах

- Роутеры FastAPI: валидация входа, вызов сервисов, возврат результата. Расчёты, смена статусов и транзакции — только в сервисах.

## 4. Атомарность

- Операции по документам, платежам и транзакциям выполняются в одной транзакции БД; не оставлять частично применённые изменения.

## 5. Миграции и схема

- Изменения моделей и схемы БД — с миграциями и фиксацией в `DevelopmentDiary.md`; не править БД вручную без миграций.
