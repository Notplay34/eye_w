# План разработки

Разбивка на небольшие понятные задачи. Порядок — по приоритету и зависимостям. После выполнения каждой задачи — запись в DEVELOPMENT_LOG.md и при крупных изменениях коммит/пуш.

---

## Этап 1. Бэкенд: основа

| № | Задача | Что сделать |
|---|--------|-------------|
| 1.1 | Структура backend | Создать папку `backend/`, подпапки `app/`, `app/models`, `app/api`, `app/core`, `app/services`. Файлы `main.py`, `config.py`, `requirements.txt` (FastAPI, uvicorn, sqlalchemy, asyncpg, pydantic-settings). |
| 1.2 | Конфиг и БД | Настроить подключение к PostgreSQL через переменные окружения (DATABASE_URL). Файл `app/core/database.py` — создание движка и сессии SQLAlchemy (async). |
| 1.3 | Модель Employee | Таблица `employees`: id, name, role (ROLE_ADMIN / ROLE_OPERATOR / ROLE_PLATE_OPERATOR), telegram_id (nullable), is_active, created_at. Миграция или create_all. |
| 1.4 | Модель Order | Таблица `orders`: id (UUID или автоинкремент), status (enum по разделу 8 PROJECT_CONTEXT), total_amount, state_duty_amount, income_pavilion1, income_pavilion2, need_plate (bool), service_type, данные клиента/ТС (JSON или отдельные поля по разделу 13), created_at, updated_at, employee_id (кто создал). |
| 1.5 | Модели Payment и Plate | Таблица `payments`: id, order_id, amount, type (госпошлина/доход и т.д.), employee_id, created_at. Таблица `plates`: id, order_id, plate_type, status (изготовлен/доплата/проблема), created_at, updated_at. |
| 1.6 | Запуск API | В `main.py` подключить роутеры (пока пустые), CORS для frontend. Команда `uvicorn app.main:app --reload`. Проверить GET /health или /docs. |

---

## Этап 2. Заказы и платежи (API)

| № | Задача | Что сделать |
|---|--------|-------------|
| 2.1 | Схемы Pydantic для заказа | Создать request/response схемы: создание заказа (поля формы из раздела 13 + суммы), ответ с id и статусом. |
| 2.2 | POST /orders | Принять данные заказа, рассчитать суммы (госпошлина, доход павильона 1/2), сохранить в БД со статусом CREATED или AWAITING_PAYMENT. Вернуть id заказа. |
| 2.3 | Валидация статусов заказа | Хелпер или сервис: переход статуса только по правилам (раздел 8). Использовать при смене статуса. |
| 2.4 | POST /orders/{id}/pay | Принять оплату: создать запись в `payments`, обновить статус заказа на PAID. Проверка: нельзя PAID без записи в payments; сумму после оплаты не менять. |
| 2.5 | GET /orders и GET /orders/{id} | Список заказов (с фильтрами по статусу/дате при необходимости), один заказ по id. Для фронта и для бота. |
| 2.6 | PATCH /orders/{id}/status | Смена статуса заказа (для павильона 2 и админа) с проверкой workflow. |

---

## Этап 3. Frontend ↔ Backend

| № | Задача | Что сделать |
|---|--------|-------------|
| 3.1 | Переменная API URL | В frontend (config или константа) базовый URL бэкенда. Разработка: localhost:8000. |
| 3.2 | Отправка заказа на бэкенд | По кнопке «Принять наличные»: собрать данные формы, POST /orders, затем POST /orders/{id}/pay. Показать id заказа, обновить UI (кнопка «Оплата принята»). |
| 3.3 | Обработка ошибок | При ошибке сети или 4xx/5xx показывать сообщение пользователю, не ломать форму. |
| 3.4 | Выбор оператора из API | GET /employees (операторы), подстановка в форму или выбор при «Принять наличные» (если нужна авторизация — позже). Минимально: передавать employee_id при создании заказа, если бэкенд принимает. |

---

## Этап 4. Генерация документов (docx)

| № | Задача | Что сделать |
|---|--------|-------------|
| 4.1 | Сервис подстановки в docx | Модуль в backend: чтение шаблона из `templates/*.docx`, замена плейсхолдеров `{{Поле}}` на значения из словаря (данные заказа + раздел 13). Библиотека python-docx или docxtpl. |
| 4.2 | Маппинг полей формы → плейсхолдеры | Словарь: имя поля формы (clientFio, vin, …) → имя в шаблоне (ФИО, VIN, …). Учесть дату (Дата ДКП и т.д.). |
| 4.3 | GET /orders/{id}/documents/{template} | По имени шаблона (например DKP.docx) сгенерировать docx, вернуть файл (StreamingResponse). Список шаблонов по типу услуги — из конфига или из PROJECT_CONTEXT. |
| 4.4 | Кнопка «Печать» во frontend | Запросить нужные документы по типу услуги (и number.docx при need_plate), открыть в новой вкладке или скачать. |

---

## Этап 5. Сотрудники и простой учёт

| № | Задача | Что сделать |
|---|--------|-------------|
| 5.1 | CRUD сотрудников (админ) | GET/POST/PATCH /employees. Минимально: список и создание (name, role). Для владельца. |
| 5.2 | Привязка оператора к заказу | При создании заказа передавать employee_id (текущий оператор). Откуда брать: пока заголовок или query; позже — сессия/токен. |
| 5.3 | Учёт по сотрудникам в платежах | В отчётах и аналитике использовать employee_id из payments. |

---

## Этап 6. Telegram-бот павильона 2

| № | Задача | Что сделать |
|---|--------|-------------|
| 6.1 | Проект бота | Папка `bot_plate/` или модуль в backend. Зависимости: aiogram или python-telegram-bot. Токен бота из переменной окружения. |
| 6.2 | Уведомление о новом заказе с номером | При переходе заказа в статус PAID и need_plate=true — вызвать из backend сервис отправки в Telegram (текст: id заказа, тип номера, сумма). Бот не хранит состояние — только получает вызов от API. |
| 6.3 | Команды для смены статуса | Коля получает сообщение с кнопками/командами: «Изготовлен», «Доплата получена», «Проблема». По нажатию — запрос к API (PATCH /orders/{id}/status или отдельный endpoint), обновление в БД. |
| 6.4 | Идентификация пользователя бота | Привязать telegram_id к сотруднику (ROLE_PLATE_OPERATOR). В API проверять: только привязанный сотрудник может менять статус заказов через бота. |

---

## Этап 7. Telegram-бот владельца (аналитика)

| № | Задача | Что сделать |
|---|--------|-------------|
| 7.1 | Проект бота владельца | Отдельный бот или тот же с разными командами. Токен из env. |
| 7.2 | Команда /today | Запрос к API: дневная выручка, количество заказов, средний чек за сегодня. Ответ ботом в чат. |
| 7.3 | Команда /month | То же за текущий месяц. |
| 7.4 | Команда /employees | Список сотрудников и учёт по ним (сколько заказов, сумма за период). API: GET /analytics/employees или аналог. |
| 7.5 | Доступ только для владельца | Проверка telegram_id по таблице employees с role=ROLE_ADMIN. |

---

## Этап 8. Аналитика и отчёты в API

| № | Задача | Что сделать |
|---|--------|-------------|
| 8.1 | GET /analytics/today | Суммы (выручка, госпошлина, доход павильонов), количество заказов, средний чек за сегодня. |
| 8.2 | GET /analytics/month | То же за текущий месяц. |
| 8.3 | GET /analytics/employees | По каждому сотруднику: число заказов, сумма за выбранный период (день/месяц). |

---

## Этап 9. Улучшения и стабилизация

| № | Задача | Что сделать |
|---|--------|-------------|
| 9.1 | Логирование | Единый логгер в backend, логирование ошибок и важных действий (создание заказа, оплата). |
| 9.2 | Обработка ошибок API | Единый формат ошибок (JSON), коды 400/404/422. |
| 9.3 | README и запуск | README: как поднять backend, frontend, ботов; пример .env. При необходимости docker-compose для PostgreSQL. |

---

## Порядок выполнения (кратко)

1. **Этап 1** — основа бэкенда и БД.  
2. **Этап 2** — заказы и оплата в API.  
3. **Этап 3** — подключить фронт к API.  
4. **Этап 4** — генерация docx и печать.  
5. **Этапы 5, 8** — сотрудники и аналитика в API.  
6. **Этапы 6, 7** — оба Telegram-бота.  
7. **Этап 9** — логи, ошибки, README.

При изменении плана или появлении новых задач — обновлять этот файл и при необходимости PROJECT_CONTEXT.md.
