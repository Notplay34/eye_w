# Аудит проекта eye_w

**Дата:** 2026-02  
**Цель:** итог состояния, слабые места, план дальнейших действий.

---

## 1. Итог по проекту

**Тип:** внутренняя система для одного бизнеса (2 павильона: документы + изготовление номеров). Не SaaS, не multi-tenant.

**Стек:** FastAPI, SQLAlchemy (async), PostgreSQL, статический frontend (HTML/CSS/JS), nginx, systemd.

**Что уже работает и задеплоено:**
- Форма заказов (павильон 1): создание заказа, расчёт сумм, приём оплаты, печать docx.
- Павильон 2: список заказов с номерами, статусы (Выдано / Проблема), доплата, ссылка «Заявление на номера».
- Касса павильона 1: таблица (ФИО, заявление, госпошлина, ДКП, страховка, номера, итого), редактирование строк, разделители по дням.
- Касса номеров: фамилия + сумма (в т.ч. отрицательная), итого внизу.
- Склад заготовок: остаток, резерв, доступно, пополнение, брак (счётчик за месяц).
- Аналитика: сводка за день (без фильтра), за месяц, по сотрудникам, экспорт CSV.
- Управление аккаунтами, роли, JWT, история заполнения формы.

**Документация:** README, INSTALL.md, USER_GUIDE.md, DEPLOYMENT.md, RELEASE_PLAN.md — достаточно для запуска и эксплуатации.

---

## 2. Слабые места

### 2.1 Безопасность и конфигурация

| Проблема | Риск | Где |
|----------|------|-----|
| Логин/пароль суперпользователя захардкожены в `main.py` | При утечке репозитория — известен дефолтный вход | `backend/app/main.py` (SUPERUSER_*) |
| CORS `allow_origins=["*"]` | Для одного домена избыточно; при появлении мобильного/внешнего API лучше ограничить | `main.py` |

**Рекомендация:** вынести создание суперпользователя в переменные окружения (или один раз создать через админку и убрать дефолтный пароль из кода).

### 2.2 База данных и миграции

| Проблема | Риск | Где |
|----------|------|-----|
| Нет системы миграций (Alembic и т.п.) | Изменения схемы через сырой SQL в `ensure_columns_and_enum()` — легко ошибиться, сложно откатывать | `main.py` lifespan |
| Создание таблиц через `Base.metadata.create_all` + отдельные `CREATE TABLE IF NOT EXISTS` и `ALTER` | Дублирование логики, риск рассинхрона при переименовании моделей | `main.py` |

**Рекомендация:** со временем ввести Alembic (или фиксировать все шаги в одном миграционном скрипте с версией) и новые изменения схемы делать только через миграции.

### 2.3 Тестирование

| Проблема | Риск |
|----------|------|
| Нет unit/integration тестов | Регрессии при правках (оплата, касса, статусы) обнаруживаются только вручную |
| Нет CI | Нет автоматической проверки после коммита |

**Рекомендация:** начать с тестов на критичные сценарии: создание заказа + pay, добавление строки кассы, смена статуса заказа (павильон 2), запросы к warehouse.

### 2.4 Frontend

| Проблема | Риск |
|----------|------|
| Дублирование: навбар и шапка повторяются в 9 HTML-файлах | Изменение меню/стилей требует правок во всех файлах |
| Крупные инлайновые скрипты в admin.html, plate-operator.html и др. | Сложнее поддерживать и отлаживать |
| Нет сборки (npm/vite и т.д.) | Нет минификации, бандлинга, строгой проверки зависимостей (осознанный выбор для текущего масштаба) |

**Плюс:** единый `styles.css`, общая дизайн-система, логика не ломалась при рефакторинге.

### 2.5 Инфраструктура и деплой

| Проблема | Риск |
|----------|------|
| Шаблоны docx не в репозитории | На новом сервере или после чистого clone нужно вручную копировать папку `templates/` |
| Nginx: один `location` с regex для API; добавление нового префикса легко забыть | Ошибки вида «сервер вернул HTML вместо JSON» (уже были с warehouse, plate-cash) |
| На части VPS нет `sudo` (вход под root) | Команды в INSTALL/DEPLOYMENT с `sudo` не сработают — в доке стоит отметить «под root без sudo» |

**Рекомендация:** в INSTALL/DEPLOYMENT явно описать: список всех префиксов API для nginx; необходимость папки `templates/` и откуда её брать; при необходимости — один скрипт деплоя, который проверяет наличие шаблонов.

### 2.6 Мёртвый код

| Проблема | Где |
|----------|-----|
| В репозитории остаётся папка `django_backend/` (если не удалена) | Занимает место, путает при чтении структуры проекта |

**Рекомендация:** окончательно удалить `django_backend/`, если он ещё есть, и убрать упоминания из документации.  
**Статус:** папка `django_backend/` в репозитории отсутствует (проверено).

### 2.7 Логирование и ошибки

| Сильное место | Комментарий |
|---------------|-------------|
| Глобальный `exception_handler` с понятными сообщениями (дубликат, foreign key, устаревшая схема) | Хорошо для пользователя и поддержки |
| Логирование через `get_logger` | Нормальная база для разбора инцидентов |

**Слабое место:** при любом необработанном исключении пользователь видит общее «Внутренняя ошибка сервера» — для отладки важно смотреть `journalctl -u eye_w`. При желании можно добавить опциональный «режим отладки» (например, по флагу в .env), чтобы в ответе возвращать тип ошибки (без стека).

---

## 3. План действий (приоритеты)

### Сейчас (низкие трудозатраты, быстрый эффект)

1. **Проверить и удалить мёртвый код**  
   Убедиться, что `django_backend/` удалён; если нет — удалить и обновить INSTALL/DevelopmentDiary.

2. **Суперпользователь из окружения**  
   Читать логин/пароль/имя суперпользователя из `backend/.env` (например `SUPERUSER_LOGIN`, `SUPERUSER_PASSWORD`, `SUPERUSER_NAME`), с дефолтами только для первой установки и явным предупреждением в INSTALL сменить пароль после входа.

3. **Документация деплоя**  
   В DEPLOYMENT или INSTALL добавить:  
   - полный список location’ов nginx для API (orders, auth/, cash/, employees, analytics, warehouse/, form-history, price-list, health, docs);  
   - что папка `templates/` обязательна и откуда её взять;  
   - при необходимости: «на части серверов вы под root — используйте команды без sudo».

### Краткосрочно (1–2 недели)

4. **Минимальные автотесты**  
   - Запуск приложения (lifespan), проверка /health.  
   - Один-два сценария: POST /orders + POST /orders/{id}/pay (с тестовой БД или моками).  
   - Опционально: тест на добавление строки кассы и запрос к warehouse.  
   Инструмент: pytest + httpx (или pytest-asyncio с TestClient FastAPI).

5. **Версионирование схемы БД**  
   Завести один файл (например `MIGRATIONS.md` или скрипт в `deploy/`) с перечнем уже выполненных шагов (create_all, ensure_columns_and_enum и т.д.). Все будущие изменения схемы делать отдельными шагами с номерами/датами и описывать там же. При желании позже заменить на Alembic.

### Среднесрочно (по желанию)

6. **Вынести общий layout фронта**  
   Общий блок шапки/навбара подключать через iframe или один JS-файл, который рисует меню (минимальный рефакторинг без сборки). Либо оставить как есть и при изменении меню править все страницы — для 9 файлов приемлемо.

7. **Резервное копирование**  
   В INSTALL/DEPLOYMENT добавить раздел «Резервное копирование БД»: примеры `pg_dump` и, при необходимости, cron.

8. **Ограничение CORS**  
   Когда зафиксирован домен/IP продакшена — задать `allow_origins` явным списком вместо `["*"]`.

### Долгосрочно (по мере необходимости)

9. **Полноценные миграции (Alembic)**  
   Когда появятся частые изменения схемы — перейти на Alembic и новые изменения вносить только миграциями.

10. **Расширение тестов**  
    Покрытие критичных API (касса, павильон 2, склад, аналитика), проверка прав по ролям.

---

## 4. Краткий чеклист «здоровья» проекта

| Критерий | Статус |
|----------|--------|
| Запуск из корня проекта (backend + frontend через nginx) | ✅ |
| Документация для установки и пользователя | ✅ |
| Роли и разграничение доступа | ✅ |
| Обработка ошибок и логи | ✅ |
| Автотесты | ✅ (pytest: health, auth, orders+pay — см. backend/tests/) |
| Миграции БД (версионированные) | ✅ (docs/MIGRATIONS.md, шаги зафиксированы) |
| Секреты не в коде (суперпользователь из .env) | ✅ |
| Нет мёртвого кода (django_backend) | ✅ (отсутствует в репо) |
| Деплой одной командой (git pull + setup_server.sh) | ✅ |

---

## 5. Итог

Проект в рабочем состоянии, подходит для внутренней эксплуатации и уже развёрнут. Главные риски: отсутствие тестов (регрессии), захардкоженный суперпользователь (безопасность), схема БД без формальных миграций (эволюция без поломок). **Выполнено (по аудиту):** суперпользователь из .env (SUPERUSER_LOGIN, SUPERUSER_PASSWORD, SUPERUSER_NAME); документация деплоя (nginx locations, templates/, root без sudo, резервное копирование); MIGRATIONS.md с версионированием шагов схемы; минимальные автотесты (pytest: /health, логин, /auth/me, создание заказа и оплата); CORS из .env (CORS_ORIGINS); чеклист обновлён. Папка django_backend в репо отсутствует.
