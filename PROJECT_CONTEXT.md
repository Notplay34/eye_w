# PROJECT_CONTEXT.md

**Главный документ архитектуры и логики проекта.**  
При проектировании и написании кода необходимо обращаться к этому файлу.

---

## 1. О проекте

**Название:** Система управления двумя павильонами автоуслуг возле МРЭО.

**Общая цель:** Единая цифровая система учёта и контроля:
- оформления документов
- изготовления номерных знаков
- учёта наличных платежей
- контроля сотрудников
- прозрачной аналитики для владельца

**Требования к системе:**
- простая
- быстрая
- устойчивая
- масштабируемая
- пригодная для превращения в SaaS в будущем

---

## 2. Структура бизнеса

### 2.1 Павильон 1 — Оформление документов

**Роль сотрудников:**
- ввод данных клиента
- выбор типа услуги
- указание госпошлины
- добавление доп. услуг
- отметка необходимости изготовления номера
- приём наличной оплаты

**Функциональные требования:**
- автоматический расчёт суммы
- кнопка «Принять наличные»
- фиксация времени
- фиксация сотрудника
- генерация документов для печати
- создание единого заказа

### 2.2 Павильон 2 — Изготовление номеров

**Сотрудник (Коля):**
- получает уведомления через Telegram
- видит новый заказ
- видит тип номера
- видит статус оплаты
- может отметить:
  - «Изготовлен»
  - «Доплата получена»
  - «Проблема»

**Важно:** Все изменения обновляют статус заказа в базе данных.

---

## 3. Финансовый учёт

Система должна:
- фиксировать все наличные оплаты
- разделять:
  - госпошлину
  - доход павильона
- вести учёт по сотрудникам
- считать:
  - дневную выручку
  - месячную выручку
  - количество заказов
  - средний чек

---

## 4. Архитектура

### 4.1 Backend
- **Язык:** Python
- **Фреймворк:** FastAPI
- **БД:** PostgreSQL

### 4.2 Frontend
- Простое веб-приложение для павильона 1

### 4.3 Telegram
- **Бот для павильона 2** — уведомления и управление заказами (изготовление номеров)
- **Бот владельца** с командами:
  - `/today` — сводка за день
  - `/month` — сводка за месяц
  - `/employees` — данные по сотрудникам

---

## 5. Основные сущности БД

| Сущность   | Назначение |
|-----------|------------|
| `orders`  | Заказы (у каждого заказа уникальный ID) |
| `payments`| Платежи (наличные, привязка к заказу и сотруднику) |
| `plates`  | Номерные знаки (тип, статус изготовления) |
| `employees` | Сотрудники (для учёта и отчётов) |

**Важно:** Каждый заказ должен иметь уникальный ID.

---

## 6. Принципы разработки

- Система должна **работать стабильно**
- **Максимально простая** — без лишней логики
- **Модульная** — чёткое разделение ответственности
- **Легко масштабируется** — задел под рост и SaaS

---

## 7. Связь с кодом

При добавлении фич, рефакторинге или исправлениях:
1. Сверяться с разделами 2–5 (бизнес-логика, финансы, архитектура, сущности).
2. Не вводить сущности и сценарии, не описанные здесь, без обновления PROJECT_CONTEXT.md.
3. Сохранять простоту и модульность.
4. **Обращаться к DEVELOPMENT_LOG.md** — учитывать уже принятые решения, описанные проблемы и их решения, не повторять прошлые ошибки; при сомнениях смотреть, как аналогичные задачи решались ранее.

---

## 8. Жизненный цикл заказа (Order Lifecycle)

Каждый заказ проходит следующие статусы:

- **CREATED** — заказ создан
- **AWAITING_PAYMENT** — ожидает оплаты
- **PAID** — полностью оплачен
- **PLATE_IN_PROGRESS** — номер изготавливается
- **PLATE_READY** — номер готов
- **COMPLETED** — заказ завершён
- **PROBLEM** — возникла проблема

**Правило:** Заказ не может перейти в следующий статус, если не выполнены условия предыдущего.

---

## 9. Логика финансов

Каждый заказ содержит:

- общую сумму
- сумму госпошлины
- доход павильона 1
- доход павильона 2

**Правила:**

- Госпошлина не считается доходом.
- Все наличные операции фиксируются в таблице `payments`.
- Нельзя создать заказ со статусом PAID без записи в `payments`.
- Нельзя изменить сумму после фиксации оплаты.

---

## 10. Роли пользователей

**ROLE_ADMIN (владелец):**
- полный доступ
- просмотр аналитики
- изменение статусов
- управление сотрудниками

**ROLE_OPERATOR (павильон 1):**
- создание заказов
- приём оплаты
- печать документов

**ROLE_PLATE_OPERATOR (павильон 2):**
- просмотр заказов с номерами
- изменение статуса изготовления
- фиксация доплат

---

## 11. Telegram-бот павильона 2

Бот:

- получает уведомление только при заказах с номерами
- отображает ID заказа
- показывает статус оплаты
- позволяет менять статус только в рамках разрешённого workflow

Бот не хранит данные — только взаимодействует через API backend.

---

## 12. Принцип «Единый источник правды»

Единственным источником данных является PostgreSQL.  
Telegram, веб-интерфейс и админка не хранят состояние локально.

---

## 13. Поля формы оператора (по шаблонам dist)

Список полей восстановлен по плейсхолдерам `{{...}}` в шаблонах docx в `dist/main/templates`. Одна форма заполняет все документы — эти поля являются единым источником для подстановки в шаблоны.

**Покупатель / клиент:**
- ФИО
- Паспорт
- Адрес
- Телефон (для связи, в шаблонах может не быть)

**Продавец** (для ДКП и др.):
- ФИО продавец
- Паспорт продавец
- Адрес продавец

**Транспортное средство** (для ДКП, МРЭО и др.):
- VIN
- Марка, модель
- Тип ТС
- Год выпуска
- Двигатель (модель, №)
- № шасси (рамы)
- № кузова
- Цвет
- СРТС
- Гос. номер
- ПТС

**Даты и суммы:**
- Дата (для документа, напр. Дата ДКП)
- Сумма ДКП (стоимость ТС по договору)

**Уже в форме:** тип услуги, госпошлина, доп. услуги, номер (изготовить/сумма), итого к оплате.

При добавлении новых полей формы или изменении шаблонов — обновлять этот раздел и DEVELOPMENT_LOG.

---

*Последнее обновление: 2025-02-14*
