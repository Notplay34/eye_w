<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>if(!localStorage.getItem('eye_w_token'))window.location.replace('login.html');</script>
  <title>Склад заготовок</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .warehouse-page { max-width: 500px; margin: 0 auto; padding: 1rem; }
    .warehouse-card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; margin-bottom: 1.5rem; }
    .warehouse-card h2 { font-size: 1rem; margin: 0 0 1rem; color: var(--text-muted); }
    .warehouse-stat { font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.25rem; }
    .warehouse-stat-label { font-size: 0.9rem; color: var(--text-muted); }
    .warehouse-row { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
    .warehouse-row input { width: 100px; padding: 0.5rem; }
    .warehouse-msg { font-size: 0.9rem; margin-top: 0.5rem; }
    .warehouse-msg.err { color: #b91c1c; }
    .warehouse-msg.ok { color: var(--income); }
    .warehouse-breakdown { font-size: 0.95rem; color: var(--text-muted); margin-top: 0.25rem; }
  </style>
</head>
<body>
  <div class="warehouse-page">
    <header class="header">
      <div>
        <h1 class="header__title">Склад заготовок</h1>
        <p class="header__subtitle">Остатки номеров, пополнение. Резерв под заказы и списание при изготовлении.</p>
      </div>
      <nav class="nav-bar">
        <span class="nav-group"><a href="account.html">Меню</a></span>
        <span class="nav-group"><a href="index.html">Павильон 1</a></span>
        <span class="nav-group"><a href="plate-operator.html">Павильон 2</a></span>
        <span class="nav-group"><a href="plate-cash.html">Касса номеров</a></span>
        <span class="nav-group"><a href="warehouse.html">Склад</a></span>
        <span class="nav-group"><a href="cash-shifts.html">Касса</a></span>
        <span class="nav-group"><a href="admin.html">Админка</a><a href="users.html">Аккаунты</a></span>
        <span class="nav-user" id="userName"></span>
        <a href="login.html" class="nav-logout" onclick="window.clearAuth()">Выйти</a>
      </nav>
    </header>

    <div class="warehouse-card">
      <h2>Остаток на складе</h2>
      <div class="warehouse-stat" id="quantity">—</div>
      <div class="warehouse-stat-label">Всего заготовок</div>
      <div class="warehouse-stat" id="reserved" style="font-size:1.25rem; margin-top:0.75rem;">—</div>
      <div class="warehouse-stat-label">Зарезервировано (невыданные заказы)</div>
      <div id="reservedBreakdown" class="warehouse-breakdown"></div>
      <div class="warehouse-stat" id="available" style="font-size:1.25rem; margin-top:0.75rem;">—</div>
      <div class="warehouse-stat-label">Доступно для новых заказов</div>
    </div>

    <div class="warehouse-card">
      <h2>Пополнить склад</h2>
      <div class="warehouse-row">
        <input type="number" id="addAmount" min="1" value="10" placeholder="Кол-во">
        <button type="button" class="btn btn--primary" id="btnAdd">Добавить</button>
      </div>
      <p id="warehouseMsg" class="warehouse-msg"></p>
    </div>

    <div class="warehouse-card">
      <h2>Списание</h2>
      <div class="warehouse-stat" id="defectsMonth" style="font-size:1.25rem;">—</div>
      <div class="warehouse-stat-label">Браков за месяц</div>
      <p class="warehouse-stat-label" style="margin:0.75rem 0 0.5rem;">При нажатии «Выдано» в павильоне 2 заказ списывается со склада. Брак — списать 1 шт из остатка.</p>
      <div class="warehouse-row">
        <button type="button" class="btn btn--secondary" id="btnDefect">Добавить брак (−1 шт)</button>
      </div>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
(function () {
  var API = window.API_BASE_URL || '';
  var fetchApi = window.fetchWithAuth || fetch;
  if (!window.getToken || !window.getToken()) return;

  var user = window.getUser();
  if (user) document.getElementById('userName').textContent = user.name || '';

  function msg(t, isErr) {
    var el = document.getElementById('warehouseMsg');
    el.textContent = t || '';
    el.className = 'warehouse-msg' + (isErr ? ' err' : ' ok');
  }

  function load() {
    var hint = ' Проверьте nginx: в location добавьте warehouse (см. deploy/nginx-eye_w.conf), затем nginx -t && systemctl reload nginx.';
    fetchApi(API + '/warehouse/plate-stock')
      .then(function (r) {
        return r.text().then(function (text) {
          var t = (text || '').trim();
          if (t.indexOf('<') === 0) {
            throw new Error('Сервер вернул HTML вместо данных.' + hint);
          }
          if (!r.ok) {
            try { var j = JSON.parse(t); throw new Error(j.detail || r.statusText); } catch (e) { if (e.message && e.message !== r.statusText) throw e; }
            throw new Error(r.statusText || 'Ошибка ' + r.status);
          }
          try { return JSON.parse(t); } catch (_) {
            throw new Error('Ответ не JSON.' + hint);
          }
        });
      })
      .then(function (d) {
        document.getElementById('quantity').textContent = d.quantity;
        document.getElementById('reserved').textContent = d.reserved;
        document.getElementById('available').textContent = d.available;
        document.getElementById('defectsMonth').textContent = d.defects_this_month != null ? d.defects_this_month : '—';
        var breakdown = d.reserved_breakdown || [];
        var el = document.getElementById('reservedBreakdown');
        if (breakdown.length === 0) {
          el.textContent = '';
        } else {
          var bySum = {};
          breakdown.forEach(function (b) {
            var sum = Math.round(b.total_amount);
            bySum[sum] = (bySum[sum] || 0) + b.quantity;
          });
          el.textContent = Object.keys(bySum).sort(function (a, b) { return Number(b) - Number(a); }).map(function (sum) {
            return sum + ' ₽ — ' + bySum[sum] + ' шт';
          }).join(', ');
        }
      })
      .catch(function (e) {
        document.getElementById('quantity').textContent = '—';
        document.getElementById('reserved').textContent = '—';
        document.getElementById('available').textContent = '—';
        document.getElementById('reservedBreakdown').textContent = '';
        document.getElementById('defectsMonth').textContent = '—';
        msg('Ошибка: ' + (e.message || ''), true);
      });
  }

  document.getElementById('btnAdd').onclick = function () {
    var inp = document.getElementById('addAmount');
    var n = parseInt(inp.value, 10);
    if (isNaN(n) || n < 1) {
      msg('Введите число больше 0', true);
      return;
    }
    fetchApi(API + '/warehouse/plate-stock/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount: n })
    })
      .then(function (r) {
        return r.text().then(function (text) {
          var t = (text || '').trim();
          if (t.indexOf('<') === 0) throw new Error('Сервер вернул HTML. Обновите nginx (добавьте warehouse в location).');
          if (!r.ok) {
            try { var j = JSON.parse(t); throw new Error(j.detail || r.statusText); } catch (e) { if (e.message && e.message !== r.statusText) throw e; }
            throw new Error(r.statusText);
          }
          return t ? JSON.parse(t) : {};
        });
      })
      .then(function () {
        msg('Добавлено ' + n + ' шт.');
        load();
        setTimeout(function () { msg(''); }, 3000);
      })
      .catch(function (e) {
        msg('Ошибка: ' + (e.message || ''), true);
      });
  };

  document.getElementById('btnDefect').onclick = function () {
    if (!confirm('Списать 1 шт как брак?')) return;
    fetchApi(API + '/warehouse/plate-stock/defect', { method: 'POST' })
      .then(function (r) {
        return r.text().then(function (text) {
          var t = (text || '').trim();
          if (t.indexOf('<') === 0) throw new Error('Сервер вернул HTML.');
          if (!r.ok) {
            try { var j = JSON.parse(t); throw new Error(j.detail || r.statusText); } catch (e) { if (e.message && e.message !== r.statusText) throw e; }
            throw new Error(r.statusText);
          }
          return t ? JSON.parse(t) : {};
        });
      })
      .then(function () {
        msg('Списано 1 шт (брак).');
        load();
        setTimeout(function () { msg(''); }, 3000);
      })
      .catch(function (e) {
        msg('Ошибка: ' + (e.message || ''), true);
      });
  };

  load();
})();
  </script>
</body>
</html>
