<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Админка — данные БД</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=PT+Serif:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .admin { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .admin h1 { font-family: var(--font-serif); margin-bottom: 0.5rem; }
    .admin__link { margin-bottom: 1rem; }
    .admin__link a { color: var(--accent); }
    .admin section { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.25rem; margin-bottom: 1.5rem; }
    .admin section h2 { font-size: 1.1rem; margin: 0 0 1rem; color: var(--text-muted); }
    .admin table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .admin th, .admin td { text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
    .admin th { color: var(--text-muted); font-weight: 500; }
    .admin .loading { color: var(--text-muted); }
    .admin .error { color: #b91c1c; }
    .admin .stats { display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1rem; }
    .admin .stat { background: var(--surface2); padding: 0.75rem 1rem; border-radius: var(--radius); }
    .admin .stat strong { display: block; font-size: 1.25rem; color: var(--accent); }
    .admin .stat span { font-size: 0.85rem; color: var(--text-muted); }
    .admin .btn-refresh { margin-bottom: 1rem; }
    .admin .text-muted { color: var(--text-muted); }
    .admin .filter-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .admin .filter-row select { padding: 0.4rem 0.6rem; min-width: 160px; }
    .admin .order-id-copy { cursor: pointer; }
    .admin .order-id-copy:hover { text-decoration: underline; color: var(--accent); }
    .admin .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 20; overflow: auto; padding: 1rem; }
    .admin .modal.show { display: flex; }
    .admin .modal__box { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); max-width: 560px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .admin .modal__box h3 { margin: 0 0 1rem; }
    .admin .detail-grid { font-size: 0.9rem; }
    .admin .detail-grid dt { color: var(--text-muted); margin: 0.25rem 0 0; }
    .admin .detail-grid dd { margin: 0 0 0 1rem; }
    .admin .btn-sm { padding: 0.35rem 0.6rem; font-size: 0.85rem; }
    .admin .price-list-table input { width: 100%; padding: 0.4rem 0.5rem; font-size: 0.9rem; }
    .admin .price-list-table input[readonly] { background: var(--surface2); color: var(--text-muted); }
  </style>
</head>
<body>
  <div class="admin">
    <h1>Админка</h1>
    <p class="admin__link"><a href="account.html">← В меню</a></p>
    <p class="text-muted" style="margin-bottom:0.5rem;">Обновить данные: кнопка ниже или перезагрузка страницы (<kbd>F5</kbd>)</p>
    <button type="button" class="btn btn-refresh" id="btnRefresh">Обновить данные</button>

    <section id="sectionToday">
      <h2>Сводка за сегодня</h2>
      <div id="todayContent" class="loading">Загрузка…</div>
    </section>

    <section id="sectionOrders">
      <h2>Заказы (последние 100)</h2>
      <div class="filter-row">
        <label>Статус:</label>
        <select id="orderStatusFilter">
          <option value="">Все</option>
          <option value="CREATED">Создан</option>
          <option value="AWAITING_PAYMENT">Ожидает оплаты</option>
          <option value="PAID">Оплачен</option>
          <option value="COMPLETED">Завершён</option>
          <option value="PROBLEM">Проблема</option>
        </select>
        <span class="text-muted">Клик по номеру — скопировать</span>
      </div>
      <div id="ordersContent" class="loading">Загрузка…</div>
    </section>

    <section id="sectionEmployees">
      <h2>Сотрудники</h2>
      <div id="employeesContent" class="loading">Загрузка…</div>
    </section>

    <section id="sectionPriceList">
      <h2>Прейскурант</h2>
      <p class="text-muted" style="margin-bottom:0.75rem;">Измените название и цену документа. Сохранённый прейскурант используется в форме заказа.</p>
      <div id="priceListContent" class="loading">Загрузка…</div>
      <p style="margin-top:0.75rem;"><button type="button" class="btn" id="btnSavePriceList">Сохранить прейскурант</button> <span id="priceListMessage" class="text-muted"></span></p>
    </section>
  </div>

  <div class="modal" id="orderDetailModal">
    <div class="modal__box">
      <h3 id="orderDetailTitle">Заказ</h3>
      <div id="orderDetailBody"></div>
      <p style="margin-top:1rem;"><button type="button" class="btn" id="orderDetailClose">Закрыть</button></p>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    (function() {
      if (!window.requireAuth()) return;
      var API_BASE = window.API_BASE_URL || (window.location.hostname === 'localhost' ? 'http://localhost:8000' : '');
      var fetchApi = window.fetchWithAuth || fetch;
      var todayEl = document.getElementById('todayContent');
      var ordersEl = document.getElementById('ordersContent');
      var employeesEl = document.getElementById('employeesContent');
      var priceListEl = document.getElementById('priceListContent');
      var priceListMessage = document.getElementById('priceListMessage');

      function showErr(el, msg) {
        el.innerHTML = '<span class="error">' + (msg || 'Ошибка загрузки') + '</span>';
      }

      async function loadToday() {
        try {
          const r = await fetchApi(API_BASE + '/analytics/today');
          if (!r.ok) throw new Error(r.statusText);
          const d = await r.json();
          todayEl.innerHTML = [
            '<div class="stats">',
            '<div class="stat"><strong>' + Number(d.total_revenue) + ' ₽</strong><span>Выручка за день</span></div>',
            '<div class="stat"><strong>' + (d.orders_count || 0) + '</strong><span>Оплаченных заказов</span></div>',
            '<div class="stat"><strong>' + Number(d.state_duty_total) + ' ₽</strong><span>Госпошлина</span></div>',
            '<div class="stat"><strong>' + Number(d.income_pavilion1) + ' ₽</strong><span>Доход павильон 1</span></div>',
            '<div class="stat"><strong>' + Number(d.income_pavilion2) + ' ₽</strong><span>Доход павильон 2</span></div>',
            '</div>'
          ].join('');
        } catch (e) {
          showErr(todayEl, e.message);
        }
      }

      var orderStatusFilter = document.getElementById('orderStatusFilter');
      function getOrdersUrl() {
        var status = orderStatusFilter && orderStatusFilter.value ? orderStatusFilter.value : '';
        return API_BASE + '/orders?limit=100' + (status ? '&status=' + encodeURIComponent(status) : '');
      }
      async function loadOrders() {
        try {
          const r = await fetchApi(getOrdersUrl());
          if (!r.ok) throw new Error(r.statusText);
          const list = await r.json();
          if (!list.length) {
            ordersEl.innerHTML = '<p class="text-muted">Заказов пока нет.</p>';
            return;
          }
          const rows = list.map(function (o) {
            var id = o.public_id || '';
            return '<tr><td class="order-id-copy" data-id="' + id.replace(/"/g, '&quot;') + '" title="Копировать номер">' + id + '</td><td>' + (o.status || '') + '</td><td>' + Number(o.total_amount) + ' ₽</td><td>' + (o.need_plate ? 'Да' : '—') + '</td><td>' + (o.service_type || '—') + '</td><td>' + (o.created_at ? new Date(o.created_at).toLocaleString('ru') : '') + '</td><td><button type="button" class="btn btn-sm btn-detail" data-order-id="' + o.id + '">Детали</button></td></tr>';
          });
          ordersEl.innerHTML = [
            '<table><thead><tr>',
            '<th>Номер</th><th>Статус</th><th>Сумма</th><th>Номер</th><th>Услуга</th><th>Создан</th><th></th>',
            '</tr></thead><tbody>', rows.join(''), '</tbody></table>'
          ].join('');
          ordersEl.querySelectorAll('.order-id-copy').forEach(function (el) {
            el.addEventListener('click', function () { copyToClipboard(el.getAttribute('data-id')); });
          });
          ordersEl.querySelectorAll('.btn-detail').forEach(function (btn) {
            btn.addEventListener('click', function () { openOrderDetail(Number(btn.getAttribute('data-order-id'))); });
          });
        } catch (e) {
          showErr(ordersEl, e.message);
        }
      }
      function copyToClipboard(text) {
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(function () { alert('Номер заказа скопирован'); });
        } else {
          var ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          alert('Номер заказа скопирован');
        }
      }
      async function openOrderDetail(orderId) {
        var modal = document.getElementById('orderDetailModal');
        var titleEl = document.getElementById('orderDetailTitle');
        var bodyEl = document.getElementById('orderDetailBody');
        bodyEl.innerHTML = '<p class="loading">Загрузка…</p>';
        modal.classList.add('show');
        try {
          var r = await fetchApi(API_BASE + '/orders/' + orderId + '/detail');
          if (!r.ok) throw new Error(r.statusText);
          var d = await r.json();
          titleEl.textContent = 'Заказ ' + (d.public_id || d.id);
          var html = '<p><strong>Статус:</strong> ' + (d.status || '') + ' &nbsp; <strong>Сумма:</strong> ' + Number(d.total_amount) + ' ₽</p>';
          if (d.created_by_name) html += '<p><strong>Оформил:</strong> ' + (d.created_by_name || '—') + '</p>';
          html += '<p><strong>Создан:</strong> ' + (d.created_at ? new Date(d.created_at).toLocaleString('ru') : '') + '</p>';
          if (d.form_data && Object.keys(d.form_data).length) {
            html += '<h4 style="margin:1rem 0 0.5rem;">Данные заказа</h4><dl class="detail-grid">';
            var labels = { client_fio: 'Клиент (ФИО)', client_passport: 'Паспорт', client_phone: 'Телефон', seller_fio: 'Продавец (ФИО)', seller_passport: 'Паспорт продавца', seller_address: 'Адрес продавца', trustee_fio: 'Доверенное лицо (ФИО)', trustee_passport: 'Паспорт доверенного', trustee_basis: 'По доверенности от', vin: 'VIN', brand_model: 'Марка/модель', year: 'Год', color: 'Цвет', service_type: 'Услуга', documents: 'Документы' };
            for (var k in d.form_data) {
              var v = d.form_data[k];
              if (v == null || v === '') continue;
              if (k === 'documents' && Array.isArray(v)) {
                var docStr = v.map(function (x) { return (x.label || x.template) + (x.price != null ? ' — ' + Number(x.price) + ' ₽' : ''); }).join(', ');
                if (docStr) html += '<dt>Документы</dt><dd>' + docStr + '</dd>';
              } else {
                html += '<dt>' + (labels[k] || k) + '</dt><dd>' + String(v) + '</dd>';
              }
            }
            html += '</dl>';
          }
          bodyEl.innerHTML = html;
        } catch (e) {
          bodyEl.innerHTML = '<p class="error">' + (e.message || 'Ошибка загрузки') + '</p>';
        }
      }
      if (orderStatusFilter) orderStatusFilter.addEventListener('change', loadOrders);
      document.getElementById('orderDetailClose').addEventListener('click', function () {
        document.getElementById('orderDetailModal').classList.remove('show');
      });
      document.getElementById('orderDetailModal').addEventListener('click', function (e) {
        if (e.target.id === 'orderDetailModal') e.target.classList.remove('show');
      });

      async function loadEmployees() {
        try {
          const r = await fetchApi(API_BASE + '/employees');
          if (!r.ok) throw new Error(r.statusText);
          const list = await r.json();
          if (!list.length) {
            employeesEl.innerHTML = '<p class="text-muted">Сотрудников нет.</p>';
            return;
          }
          const rows = list.map(e => [
            '<tr>',
            '<td>' + (e.id) + '</td>',
            '<td>' + (e.name || '') + '</td>',
            '<td>' + (e.role || '') + '</td>',
            '<td>' + (e.telegram_id != null ? e.telegram_id : '—') + '</td>',
            '<td>' + (e.is_active ? 'Да' : 'Нет') + '</td>',
            '</tr>'
          ].join(''));
          employeesEl.innerHTML = [
            '<table><thead><tr>',
            '<th>ID</th><th>Имя</th><th>Роль</th><th>Telegram ID</th><th>Активен</th>',
            '</tr></thead><tbody>', rows.join(''), '</tbody></table>'
          ].join('');
        } catch (e) {
          showErr(employeesEl, e.message);
        }
      }

      async function loadPriceList() {
        if (!priceListEl) return;
        try {
          var r = await fetchApi(API_BASE + '/price-list');
          if (!r.ok) throw new Error(r.statusText);
          var text = await r.text();
          if (text.trim().charAt(0) === '<') throw new Error('Сервер вернул страницу вместо данных. Проверьте nginx: location /price-list должен проксироваться на бэкенд.');
          var list;
          try { list = JSON.parse(text); } catch (parseErr) { throw new Error('Ответ не JSON. Проверьте проксирование /price-list на бэкенд.'); }
          if (!Array.isArray(list) || !list.length) {
            priceListEl.innerHTML = '<p class="text-muted">Прейскурант пуст.</p>';
            return;
          }
          priceListEl.innerHTML = '<table class="price-list-table"><thead><tr><th>Шаблон</th><th>Название</th><th>Цена, ₽</th></tr></thead><tbody>' +
            list.map(function (item, i) {
              var t = (item.template || '').replace(/"/g, '&quot;');
              var lab = (item.label || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
              var pr = item.price != null ? Number(item.price) : 0;
              return '<tr data-index="' + i + '"><td><input type="text" value="' + t + '" readonly data-field="template"></td><td><input type="text" value="' + lab + '" data-field="label" placeholder="Название"></td><td><input type="number" min="0" step="1" value="' + pr + '" data-field="price" placeholder="0"></td></tr>';
            }).join('') +
            '</tbody></table>';
        } catch (e) {
          priceListEl.innerHTML = '<span class="error">' + (e.message || 'Ошибка загрузки') + '</span>';
        }
      }

      async function savePriceList() {
        var rows = priceListEl && priceListEl.querySelectorAll('tbody tr');
        if (!rows || !rows.length) return;
        var items = [];
        for (var i = 0; i < rows.length; i++) {
          var r = rows[i];
          var template = r.querySelector('input[data-field="template"]');
          var label = r.querySelector('input[data-field="label"]');
          var price = r.querySelector('input[data-field="price"]');
          if (!template || !label || !price) continue;
          items.push({ template: template.value.trim(), label: label.value.trim(), price: Math.max(0, parseFloat(price.value) || 0), sort_order: i });
        }
        if (priceListMessage) priceListMessage.textContent = 'Сохранение…';
        try {
          var r = await fetchApi(API_BASE + '/price-list', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(items) });
          var respText = await r.text();
          if (!r.ok) {
            var err = {};
            if (respText.trim().charAt(0) === '{') try { err = JSON.parse(respText); } catch (z) {}
            if (r.status === 403) throw new Error('Только для администратора');
            throw new Error((err.detail || r.statusText) + (respText.trim().charAt(0) === '<' ? ' (сервер вернул HTML — проверьте nginx: /price-list)' : ''));
          }
          if (respText.trim().charAt(0) === '<') throw new Error('Сервер вернул HTML вместо JSON. Добавьте в nginx: location /price-list { proxy_pass http://127.0.0.1:8000; proxy_set_header Host $host; proxy_set_header Authorization $http_authorization; }');
          if (priceListMessage) priceListMessage.textContent = 'Сохранено.';
          setTimeout(function() { if (priceListMessage) priceListMessage.textContent = ''; }, 3000);
          loadPriceList();
        } catch (e) {
          if (priceListMessage) priceListMessage.textContent = '';
          alert('Ошибка: ' + (e.message || 'Не удалось сохранить'));
        }
      }

      function refresh() {
        todayEl.textContent = 'Загрузка…';
        ordersEl.textContent = 'Загрузка…';
        employeesEl.textContent = 'Загрузка…';
        if (priceListEl) priceListEl.textContent = 'Загрузка…';
        loadToday();
        loadOrders();
        loadEmployees();
        loadPriceList();
      }

      document.getElementById('btnRefresh').addEventListener('click', refresh);
      if (document.getElementById('btnSavePriceList')) document.getElementById('btnSavePriceList').addEventListener('click', savePriceList);
      refresh();
    })();
  </script>
</body>
</html>
