<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Админка — данные БД</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=PT+Serif:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="admin">
    <header class="header">
      <div>
        <h1 class="header__title">Админка</h1>
        <p class="header__subtitle">Аналитика, заказы, сотрудники, прейскурант</p>
      </div>
      <nav class="nav-bar">
        <span class="nav-group"><a href="account.html">Меню</a></span>
        <span class="nav-group"><a href="index.html">Павильон 1</a></span>
        <span class="nav-group"><a href="plate-operator.html">Павильон 2</a></span>
        <span class="nav-group"><a href="plate-cash.html">Касса номеров</a></span>
        <span class="nav-group"><a href="warehouse.html">Склад</a></span>
        <span class="nav-group"><a href="cash-shifts.html">Касса</a></span>
        <span class="nav-group"><a href="admin.html">Админка</a><a href="users.html">Аккаунты</a></span>
        <span class="nav-user" id="adminUserName"></span>
        <a href="login.html" class="nav-logout" onclick="window.clearAuth()">Выйти</a>
      </nav>
    </header>
    <p class="text-muted" style="margin-bottom:0.5rem;">Обновить данные: кнопка ниже или перезагрузка страницы (<kbd>F5</kbd>)</p>
    <button type="button" class="btn btn-refresh" id="btnRefresh">Обновить данные</button>

    <div class="admin-block" style="margin-bottom: 2rem;">
      <h2 style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin: 0 0 0.75rem;">Аналитика</h2>
    <section id="sectionToday">
      <h2>Сводка за день</h2>
      <div class="filter-row">
        <label>Дата с:</label>
        <input type="date" id="todayDateFrom" title="Начало периода">
        <label>по:</label>
        <input type="date" id="todayDateTo" title="Конец периода">
      </div>
      <div id="todayContent" class="loading">Загрузка…</div>
    </section>

    <section id="sectionMonth">
      <h2>Сводка за месяц</h2>
      <div class="filter-row">
        <label>Дата с:</label>
        <input type="date" id="monthDateFrom" title="Начало периода">
        <label>по:</label>
        <input type="date" id="monthDateTo" title="Конец периода">
      </div>
      <div id="monthContent" class="loading">Загрузка…</div>
    </section>

    <section id="sectionEmpAnalytics">
      <h2>Учёт по сотрудникам</h2>
      <div class="filter-row">
        <label>Период:</label>
        <select id="empPeriodFilter">
          <option value="day">День</option>
          <option value="month">Месяц</option>
        </select>
        <label>Дата с:</label>
        <input type="date" id="empDateFrom">
        <label>по:</label>
        <input type="date" id="empDateTo">
      </div>
      <div id="empAnalyticsContent" class="loading">Загрузка…</div>
    </section>

    <div class="filter-row" style="margin-bottom:1rem;">
      <label>Экспорт:</label>
      <select id="exportPeriod">
        <option value="day">Сводка за день</option>
        <option value="month">Сводка за месяц</option>
        <option value="employees">По сотрудникам</option>
      </select>
      <input type="date" id="exportDateFrom">
      <input type="date" id="exportDateTo">
      <button type="button" class="btn" id="btnExportCsv">Скачать CSV</button>
    </div>
    </div>

    <div class="admin-block" style="margin-bottom: 2rem;">
      <h2 style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin: 0 0 0.75rem;">Данные</h2>
    <section id="sectionOrders">
      <h2>Заказы (последние 100)</h2>
      <div class="filter-row">
        <label>Статус:</label>
        <select id="orderStatusFilter">
          <option value="">Все</option>
          <option value="CREATED">Создан</option>
          <option value="AWAITING_PAYMENT">Ожидает оплаты</option>
          <option value="PAID">Оплачен</option>
          <option value="COMPLETED">Завершён</option>
          <option value="PROBLEM">Проблема</option>
        </select>
        <span class="text-muted">Клик по номеру — скопировать</span>
      </div>
      <div id="ordersContent" class="loading">Загрузка…</div>
    </section>

    <section id="sectionEmployees">
      <h2>Сотрудники</h2>
      <div id="employeesContent" class="loading">Загрузка…</div>
    </section>
    </div>

    <div class="admin-block" style="margin-bottom: 2rem;">
      <h2 style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin: 0 0 0.75rem;">Настройки</h2>
    <section id="sectionPriceList">
      <h2>Прейскурант</h2>
      <p class="text-muted" style="margin-bottom:0.75rem;">Меняйте название и цену, добавляйте и удаляйте позиции. Сохранённый прейскурант используется в форме заказа.</p>
      <div id="priceListContent" class="loading">Загрузка…</div>
      <p style="margin-top:0.75rem;">
        <button type="button" class="btn" id="btnAddPriceRow">Добавить позицию</button>
        <button type="button" class="btn" id="btnSavePriceList">Сохранить прейскурант</button>
        <span id="priceListMessage" class="text-muted"></span>
      </p>
    </section>
    </div>
  </div>

  <div class="modal" id="orderDetailModal">
    <div class="modal__box">
      <h3 id="orderDetailTitle">Заказ</h3>
      <div id="orderDetailBody"></div>
      <p style="margin-top:1rem;"><button type="button" class="btn" id="orderDetailClose">Закрыть</button></p>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    (function() {
      if (!window.requireAuth()) return;
      var user = window.getUser();
      if (user && document.getElementById('adminUserName')) document.getElementById('adminUserName').textContent = user.name || '';
      var API_BASE = window.API_BASE_URL || (window.location.hostname === 'localhost' ? 'http://localhost:8000' : '');
      var fetchApi = window.fetchWithAuth || fetch;
      var todayEl = document.getElementById('todayContent');
      var monthEl = document.getElementById('monthContent');
      var empAnalyticsEl = document.getElementById('empAnalyticsContent');
      var ordersEl = document.getElementById('ordersContent');
      var employeesEl = document.getElementById('employeesContent');
      var priceListEl = document.getElementById('priceListContent');
      var priceListMessage = document.getElementById('priceListMessage');

      function showErr(el, msg) {
        el.innerHTML = '<span class="error">' + (msg || 'Ошибка загрузки') + '</span>';
      }

      function getDateParams(prefix) {
        var fromEl = document.getElementById(prefix + 'DateFrom');
        var toEl = document.getElementById(prefix + 'DateTo');
        var fromVal = fromEl && fromEl.value ? fromEl.value : '';
        var toVal = toEl && toEl.value ? toEl.value : '';
        var q = [];
        if (fromVal) q.push('date_from=' + encodeURIComponent(fromVal));
        if (toVal) q.push('date_to=' + encodeURIComponent(toVal));
        return q.length ? '?' + q.join('&') : '';
      }
      function getEmpDateParams() {
        var fromEl = document.getElementById('empDateFrom');
        var toEl = document.getElementById('empDateTo');
        var fromVal = fromEl && fromEl.value ? fromEl.value : '';
        var toVal = toEl && toEl.value ? toEl.value : '';
        var q = ['period=' + getEmpPeriod()];
        if (fromVal) q.push('date_from=' + encodeURIComponent(fromVal));
        if (toVal) q.push('date_to=' + encodeURIComponent(toVal));
        return '?' + q.join('&');
      }
      async function loadToday() {
        try {
          const r = await fetchApi(API_BASE + '/analytics/today' + getDateParams('today'));
          if (!r.ok) throw new Error(r.statusText);
          const d = await r.json();
          todayEl.innerHTML = [
            '<div class="stats">',
            '<div class="stat"><strong>' + Number(d.total_revenue) + ' ₽</strong><span>Выручка за день</span></div>',
            '<div class="stat"><strong>' + (d.orders_count || 0) + '</strong><span>Оплаченных заказов</span></div>',
            '<div class="stat"><strong>' + Number(d.state_duty_total) + ' ₽</strong><span>Госпошлина</span></div>',
            '<div class="stat"><strong>' + Number(d.income_pavilion1) + ' ₽</strong><span>Доход павильон 1</span></div>',
            '<div class="stat"><strong>' + Number(d.income_pavilion2) + ' ₽</strong><span>Доход павильон 2</span></div>',
            '</div>'
          ].join('');
        } catch (e) {
          showErr(todayEl, e.message);
        }
      }

      async function loadMonth() {
        try {
          const r = await fetchApi(API_BASE + '/analytics/month' + getDateParams('month'));
          if (!r.ok) throw new Error(r.statusText);
          const d = await r.json();
          monthEl.innerHTML = [
            '<div class="stats">',
            '<div class="stat"><strong>' + Number(d.total_revenue) + ' ₽</strong><span>Выручка за месяц</span></div>',
            '<div class="stat"><strong>' + (d.orders_count || 0) + '</strong><span>Оплаченных заказов</span></div>',
            '<div class="stat"><strong>' + Number(d.state_duty_total) + ' ₽</strong><span>Госпошлина</span></div>',
            '<div class="stat"><strong>' + Number(d.income_pavilion1) + ' ₽</strong><span>Доход павильон 1</span></div>',
            '<div class="stat"><strong>' + Number(d.income_pavilion2) + ' ₽</strong><span>Доход павильон 2</span></div>',
            '</div>'
          ].join('');
        } catch (e) {
          showErr(monthEl, e.message);
        }
      }

      function getEmpPeriod() {
        var sel = document.getElementById('empPeriodFilter');
        return sel && sel.value ? sel.value : 'day';
      }
      async function loadEmpAnalytics() {
        try {
          var period = getEmpPeriod();
          const r = await fetchApi(API_BASE + '/analytics/employees' + getEmpDateParams());
          if (!r.ok) throw new Error(r.statusText);
          const d = await r.json();
          if (!d.employees || !d.employees.length) {
            empAnalyticsEl.innerHTML = '<p class="text-muted">Нет данных за выбранный период.</p>';
            return;
          }
          var rows = d.employees.map(function (e) {
            return '<tr><td>' + (e.employee_name || '—') + '</td><td>' + (e.orders_count || 0) + '</td><td>' + Number(e.total_amount) + ' ₽</td></tr>';
          });
          empAnalyticsEl.innerHTML = '<table><thead><tr><th>Сотрудник</th><th>Заказов</th><th>Сумма</th></tr></thead><tbody>' + rows.join('') + '</tbody></table>';
        } catch (e) {
          showErr(empAnalyticsEl, e.message);
        }
      }
      if (document.getElementById('empPeriodFilter')) {
        document.getElementById('empPeriodFilter').addEventListener('change', loadEmpAnalytics);
      }
      ['todayDateFrom', 'todayDateTo'].forEach(function (id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('change', loadToday);
      });
      ['monthDateFrom', 'monthDateTo'].forEach(function (id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('change', loadMonth);
      });
      ['empDateFrom', 'empDateTo'].forEach(function (id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('change', loadEmpAnalytics);
      });
      document.getElementById('btnExportCsv').addEventListener('click', function () {
        var period = document.getElementById('exportPeriod').value;
        var fromEl = document.getElementById('exportDateFrom');
        var toEl = document.getElementById('exportDateTo');
        var fromVal = fromEl && fromEl.value ? fromEl.value : '';
        var toVal = toEl && toEl.value ? toEl.value : '';
        var q = ['format=csv', 'period=' + period];
        if (fromVal) q.push('date_from=' + encodeURIComponent(fromVal));
        if (toVal) q.push('date_to=' + encodeURIComponent(toVal));
        var url = API_BASE + '/analytics/export?' + q.join('&');
        fetchApi(url).then(function (r) {
          if (!r.ok) throw new Error(r.statusText);
          return r.text();
        }).then(function (text) {
          var blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
          var a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'analytics_' + period + '.csv';
          a.click();
          URL.revokeObjectURL(a.href);
        }).catch(function (e) {
          alert('Ошибка экспорта: ' + (e.message || ''));
        });
      });

      var orderStatusFilter = document.getElementById('orderStatusFilter');
      function getOrdersUrl() {
        var status = orderStatusFilter && orderStatusFilter.value ? orderStatusFilter.value : '';
        return API_BASE + '/orders?limit=100' + (status ? '&status=' + encodeURIComponent(status) : '');
      }
      async function loadOrders() {
        try {
          const r = await fetchApi(getOrdersUrl());
          if (!r.ok) throw new Error(r.statusText);
          const list = await r.json();
          if (!list.length) {
            ordersEl.innerHTML = '<p class="text-muted">Заказов пока нет.</p>';
            return;
          }
          const rows = list.map(function (o) {
            var id = o.public_id || '';
            return '<tr><td class="order-id-copy" data-id="' + id.replace(/"/g, '&quot;') + '" title="Копировать номер">' + id + '</td><td>' + (o.status || '') + '</td><td>' + Number(o.total_amount) + ' ₽</td><td>' + (o.need_plate ? 'Да' : '—') + '</td><td>' + (o.service_type || '—') + '</td><td>' + (o.created_at ? new Date(o.created_at).toLocaleString('ru') : '') + '</td><td><button type="button" class="btn btn-sm btn-detail" data-order-id="' + o.id + '">Детали</button></td></tr>';
          });
          ordersEl.innerHTML = [
            '<table><thead><tr>',
            '<th>Номер</th><th>Статус</th><th>Сумма</th><th>Номер</th><th>Услуга</th><th>Создан</th><th></th>',
            '</tr></thead><tbody>', rows.join(''), '</tbody></table>'
          ].join('');
          ordersEl.querySelectorAll('.order-id-copy').forEach(function (el) {
            el.addEventListener('click', function () { copyToClipboard(el.getAttribute('data-id')); });
          });
          ordersEl.querySelectorAll('.btn-detail').forEach(function (btn) {
            btn.addEventListener('click', function () { openOrderDetail(Number(btn.getAttribute('data-order-id'))); });
          });
        } catch (e) {
          showErr(ordersEl, e.message);
        }
      }
      function copyToClipboard(text) {
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(function () { alert('Номер заказа скопирован'); });
        } else {
          var ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          alert('Номер заказа скопирован');
        }
      }
      async function openOrderDetail(orderId) {
        var modal = document.getElementById('orderDetailModal');
        var titleEl = document.getElementById('orderDetailTitle');
        var bodyEl = document.getElementById('orderDetailBody');
        bodyEl.innerHTML = '<p class="loading">Загрузка…</p>';
        modal.classList.add('show');
        try {
          var r = await fetchApi(API_BASE + '/orders/' + orderId + '/detail');
          if (!r.ok) throw new Error(r.statusText);
          var d = await r.json();
          titleEl.textContent = 'Заказ ' + (d.public_id || d.id);
          var html = '<p><strong>Статус:</strong> ' + (d.status || '') + ' &nbsp; <strong>Сумма:</strong> ' + Number(d.total_amount) + ' ₽</p>';
          if (d.created_by_name) html += '<p><strong>Оформил:</strong> ' + (d.created_by_name || '—') + '</p>';
          html += '<p><strong>Создан:</strong> ' + (d.created_at ? new Date(d.created_at).toLocaleString('ru') : '') + '</p>';
          if (d.form_data && Object.keys(d.form_data).length) {
            html += '<h4 style="margin:1rem 0 0.5rem;">Данные заказа</h4><dl class="detail-grid">';
            var labels = { client_fio: 'Клиент (ФИО)', client_passport: 'Паспорт', client_address: 'Адрес', client_phone: 'Телефон', client_is_legal: 'Клиент — юр. лицо', client_legal_name: 'Название (юр. лицо)', client_inn: 'ИНН', client_ogrn: 'ОГРН', seller_fio: 'Продавец (ФИО)', seller_passport: 'Паспорт продавца', seller_address: 'Адрес продавца', trustee_fio: 'Доверенное лицо (ФИО)', trustee_passport: 'Паспорт доверенного', trustee_basis: 'По доверенности от', vin: 'VIN', brand_model: 'Марка/модель', year: 'Год', color: 'Цвет', dkp_date: 'Дата договора ДКП', dkp_number: 'Номер договора ДКП', dkp_summary: 'ДКП (вручную)', summa_dkp: 'Сумма ДКП', plate_quantity: 'Кол-во номеров', service_type: 'Услуга', documents: 'Документы' };
            for (var k in d.form_data) {
              var v = d.form_data[k];
              if (v == null || v === '') continue;
              if (k === 'documents' && Array.isArray(v)) {
                var docStr = v.map(function (x) { return (x.label || x.template) + (x.price != null ? ' — ' + Number(x.price) + ' ₽' : ''); }).join(', ');
                if (docStr) html += '<dt>Документы</dt><dd>' + docStr + '</dd>';
              } else {
                html += '<dt>' + (labels[k] || k) + '</dt><dd>' + String(v) + '</dd>';
              }
            }
            html += '</dl>';
          }
          bodyEl.innerHTML = html;
        } catch (e) {
          bodyEl.innerHTML = '<p class="error">' + (e.message || 'Ошибка загрузки') + '</p>';
        }
      }
      if (orderStatusFilter) orderStatusFilter.addEventListener('change', loadOrders);
      document.getElementById('orderDetailClose').addEventListener('click', function () {
        document.getElementById('orderDetailModal').classList.remove('show');
      });
      document.getElementById('orderDetailModal').addEventListener('click', function (e) {
        if (e.target.id === 'orderDetailModal') e.target.classList.remove('show');
      });

      async function loadEmployees() {
        try {
          const r = await fetchApi(API_BASE + '/employees');
          if (!r.ok) throw new Error(r.statusText);
          const list = await r.json();
          if (!list.length) {
            employeesEl.innerHTML = '<p class="text-muted">Сотрудников нет.</p>';
            return;
          }
          const rows = list.map(e => [
            '<tr>',
            '<td>' + (e.id) + '</td>',
            '<td>' + (e.name || '') + '</td>',
            '<td>' + (e.role || '') + '</td>',
            '<td>' + (e.login || '—') + '</td>',
            '<td>' + (e.is_active ? 'Да' : 'Нет') + '</td>',
            '</tr>'
          ].join(''));
          employeesEl.innerHTML = [
            '<table><thead><tr>',
            '<th>ID</th><th>Имя</th><th>Роль</th><th>Логин</th><th>Активен</th>',
            '</tr></thead><tbody>', rows.join(''), '</tbody></table>'
          ].join('');
        } catch (e) {
          showErr(employeesEl, e.message);
        }
      }

      function priceListRowHtml(item) {
        var t = (item.template || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
        var lab = (item.label || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
        var pr = item.price != null ? Number(item.price) : 0;
        return '<tr><td><input type="text" value="' + t + '" data-field="template" placeholder="файл.docx"></td><td><input type="text" value="' + lab + '" data-field="label" placeholder="Название"></td><td><input type="number" min="0" step="1" value="' + pr + '" data-field="price" placeholder="0"></td><td><button type="button" class="btn btn-sm price-list-remove">Удалить</button></td></tr>';
      }
      function bindPriceListEvents() {
        if (!priceListEl) return;
        priceListEl.querySelectorAll('.price-list-remove').forEach(function (btn) {
          btn.onclick = function () { var tr = btn.closest('tr'); if (tr) tr.remove(); };
        });
      }
      function renderPriceListTable(list) {
        var isArray = Array.isArray(list);
        if (!priceListEl) return;
        if (isArray && list.length === 0) {
          priceListEl.innerHTML = '<table class="price-list-table"><thead><tr><th>Шаблон</th><th>Название</th><th>Цена, ₽</th><th></th></tr></thead><tbody></tbody></table>';
        } else {
          var rows = (isArray ? list : []).map(priceListRowHtml).join('');
          priceListEl.innerHTML = '<table class="price-list-table"><thead><tr><th>Шаблон</th><th>Название</th><th>Цена, ₽</th><th></th></tr></thead><tbody>' + rows + '</tbody></table>';
        }
        bindPriceListEvents();
      }
      function addPriceRow() {
        if (!priceListEl) return;
        var tbody = priceListEl.querySelector('tbody');
        if (!tbody) {
          renderPriceListTable([]);
          tbody = priceListEl.querySelector('tbody');
        }
        if (tbody) {
          var tr = document.createElement('tr');
          tr.innerHTML = '<td><input type="text" data-field="template" placeholder="файл.docx"></td><td><input type="text" data-field="label" placeholder="Название"></td><td><input type="number" min="0" step="1" value="0" data-field="price"></td><td><button type="button" class="btn btn-sm price-list-remove">Удалить</button></td>';
          tbody.appendChild(tr);
          bindPriceListEvents();
        }
      }
      async function loadPriceList() {
        if (!priceListEl) return;
        try {
          var r = await fetchApi(API_BASE + '/price-list');
          var text = await r.text();
          if (text.trim().charAt(0) === '<') {
            priceListEl.innerHTML = '<p class="error">Сервер вернул страницу вместо данных.</p><p class="text-muted" style="font-size:0.85rem; margin-top:0.5rem;">На сервере в nginx добавьте в конфиг (внутри server { ... }):<br><code style="display:block; margin-top:0.25rem;">location /price-list { proxy_pass http://127.0.0.1:8000; proxy_set_header Host $host; proxy_set_header Authorization $http_authorization; }</code> Затем: <code>nginx -t &amp;&amp; systemctl reload nginx</code></p><p style="margin-top:0.75rem;">Можно добавить позиции вручную и нажать «Сохранить» после исправления nginx.</p><table class="price-list-table"><thead><tr><th>Шаблон</th><th>Название</th><th>Цена, ₽</th><th></th></tr></thead><tbody></tbody></table>';
            bindPriceListEvents();
            return;
          }
          if (!r.ok) throw new Error(r.statusText);
          var list;
          try { list = JSON.parse(text); } catch (parseErr) { throw new Error('Ответ не JSON.'); }
          if (!Array.isArray(list)) list = [];
          renderPriceListTable(list.length ? list : []);
        } catch (e) {
          priceListEl.innerHTML = '<p class="error">' + (e.message || 'Ошибка загрузки') + '</p><table class="price-list-table"><thead><tr><th>Шаблон</th><th>Название</th><th>Цена, ₽</th><th></th></tr></thead><tbody></tbody></table>';
          bindPriceListEvents();
        }
      }

      async function savePriceList() {
        var rows = priceListEl && priceListEl.querySelectorAll('tbody tr');
        if (!rows || !rows.length) {
          alert('Добавьте хотя бы одну позицию (кнопка «Добавить позицию»).');
          return;
        }
        var items = [];
        for (var i = 0; i < rows.length; i++) {
          var r = rows[i];
          var template = r.querySelector('input[data-field="template"]');
          var label = r.querySelector('input[data-field="label"]');
          var price = r.querySelector('input[data-field="price"]');
          if (!template || !label || !price) continue;
          var t = template.value.trim();
          if (!t) continue;
          items.push({ template: t, label: label.value.trim(), price: Math.max(0, parseFloat(price.value) || 0), sort_order: items.length });
        }
        if (!items.length) {
          alert('Заполните шаблон (имя файла, например zaiavlenie.docx) у каждой позиции.');
          return;
        }
        if (priceListMessage) priceListMessage.textContent = 'Сохранение…';
        try {
          var r = await fetchApi(API_BASE + '/price-list', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(items) });
          var respText = await r.text();
          if (!r.ok) {
            var err = {};
            if (respText.trim().charAt(0) === '{') try { err = JSON.parse(respText); } catch (z) {}
            if (r.status === 403) throw new Error('Только для администратора');
            throw new Error((err.detail || r.statusText) + (respText.trim().charAt(0) === '<' ? ' (сервер вернул HTML — проверьте nginx: /price-list)' : ''));
          }
          if (respText.trim().charAt(0) === '<') throw new Error('Сервер вернул HTML вместо JSON. Добавьте в nginx: location /price-list { proxy_pass http://127.0.0.1:8000; proxy_set_header Host $host; proxy_set_header Authorization $http_authorization; }');
          if (priceListMessage) priceListMessage.textContent = 'Сохранено.';
          setTimeout(function() { if (priceListMessage) priceListMessage.textContent = ''; }, 3000);
          loadPriceList();
        } catch (e) {
          if (priceListMessage) priceListMessage.textContent = '';
          alert('Ошибка: ' + (e.message || 'Не удалось сохранить'));
        }
      }

      function refresh() {
        todayEl.textContent = 'Загрузка…';
        if (monthEl) monthEl.textContent = 'Загрузка…';
        if (empAnalyticsEl) empAnalyticsEl.textContent = 'Загрузка…';
        ordersEl.textContent = 'Загрузка…';
        employeesEl.textContent = 'Загрузка…';
        if (priceListEl) priceListEl.textContent = 'Загрузка…';
        loadToday();
        loadMonth();
        loadEmpAnalytics();
        loadOrders();
        loadEmployees();
        loadPriceList();
      }

      document.getElementById('btnRefresh').addEventListener('click', refresh);
      if (document.getElementById('btnSavePriceList')) document.getElementById('btnSavePriceList').addEventListener('click', savePriceList);
      if (document.getElementById('btnAddPriceRow')) document.getElementById('btnAddPriceRow').addEventListener('click', addPriceRow);
      refresh();
    })();
  </script>
</body>
</html>
