<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>if(!localStorage.getItem('eye_w_token'))window.location.replace('login.html');</script>
  <title>Павильон 1 — Оформление заказов</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=PT+Serif:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <header class="header">
      <h1 class="header__title">Оформление документов</h1>
      <div class="header__user" id="headerUser">
        <span id="currentUserName"></span>
        <a href="login.html" id="btnLogout" style="margin-left:0.5rem;">Выйти</a>
      </div>
    </header>

    <main class="main">
      <!-- Основная форма: один блок ввода — остальное подставляется -->
      <section class="card card--primary" id="mainForm">
        <h2 class="card__title">Данные заказа</h2>

        <fieldset class="form-section">
          <legend class="form-section__title">Покупатель / клиент</legend>
          <div class="form-grid">
            <div class="field">
              <label class="field__label" for="clientFio">ФИО</label>
              <input type="text" id="clientFio" class="field__input" placeholder="Иванов Иван Иванович" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="clientPassport">Паспорт</label>
              <input type="text" id="clientPassport" class="field__input" placeholder="серия номер" autocomplete="off">
            </div>
            <div class="field field--full">
              <label class="field__label" for="clientAddress">Адрес</label>
              <input type="text" id="clientAddress" class="field__input" placeholder="адрес регистрации" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="clientPhone">Телефон</label>
              <input type="tel" id="clientPhone" class="field__input" placeholder="+7 (___) ___-__-__" autocomplete="off">
            </div>
            <div class="field field--full">
              <label class="field__label" for="clientComment">Комментарий</label>
              <input type="text" id="clientComment" class="field__input" placeholder="Необязательно" autocomplete="off">
            </div>
          </div>
        </fieldset>

        <fieldset class="form-section form-section--togglable" id="sectionSeller">
          <div class="form-section__toggle">
            <label class="toggle-label">
              <input type="checkbox" id="hasSeller" class="toggle-label__input" autocomplete="off">
              <span class="toggle-label__box"></span>
              <span class="toggle-label__text">Продавец (для ДКП)</span>
            </label>
          </div>
          <div class="form-section__body form-section__body--closed" id="sellerBody">
            <div class="form-grid">
              <div class="field">
                <label class="field__label" for="sellerFio">ФИО продавца</label>
                <input type="text" id="sellerFio" class="field__input" placeholder="Иванов Иван Иванович" autocomplete="off">
              </div>
              <div class="field">
                <label class="field__label" for="sellerPassport">Паспорт</label>
                <input type="text" id="sellerPassport" class="field__input" placeholder="серия номер" autocomplete="off">
              </div>
              <div class="field field--full">
                <label class="field__label" for="sellerAddress">Адрес</label>
                <input type="text" id="sellerAddress" class="field__input" placeholder="адрес регистрации" autocomplete="off">
              </div>
            </div>
            <div class="form-section__sub form-section__sub--dkp">
              <div class="form-section__sub-title">Данные договора (дата, сумма, номер)</div>
              <div class="form-grid form-grid--dkp">
                <div class="field">
                  <label class="field__label" for="dkpDate">Дата договора</label>
                  <input type="text" id="dkpDate" class="field__input" placeholder="ДД.ММ.ГГГГ" autocomplete="off">
                </div>
                <div class="field">
                  <label class="field__label" for="summaDkp">Сумма договора, ₽</label>
                  <input type="number" id="summaDkp" class="field__input field__input--number" min="0" step="1" value="0" placeholder="0">
                </div>
                <div class="field">
                  <label class="field__label" for="dkpNumber">Номер договора (если есть)</label>
                  <input type="text" id="dkpNumber" class="field__input" placeholder="—" autocomplete="off">
                </div>
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset class="form-section form-section--togglable" id="sectionTrustee">
          <div class="form-section__toggle">
            <label class="toggle-label">
              <input type="checkbox" id="hasTrustee" class="toggle-label__input" autocomplete="off">
              <span class="toggle-label__box"></span>
              <span class="toggle-label__text">Доверенное лицо (действует по доверенности)</span>
            </label>
          </div>
          <div class="form-section__body form-section__body--closed" id="trusteeBody">
            <div class="form-grid">
              <div class="field">
                <label class="field__label" for="trusteeFio">ФИО доверенного лица</label>
                <input type="text" id="trusteeFio" class="field__input" placeholder="ФИО" autocomplete="off">
              </div>
              <div class="field">
                <label class="field__label" for="trusteePassport">Паспорт</label>
                <input type="text" id="trusteePassport" class="field__input" placeholder="серия номер" autocomplete="off">
              </div>
              <div class="field field--full">
                <label class="field__label" for="trusteeBasis">По доверенности от (дата, номер)</label>
                <input type="text" id="trusteeBasis" class="field__input" placeholder="например: № 123 от 01.01.2024" autocomplete="off">
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset class="form-section">
          <legend class="form-section__title">Транспортное средство</legend>
          <div class="form-grid form-grid--wide">
            <div class="field">
              <label class="field__label" for="vin">VIN</label>
              <input type="text" id="vin" class="field__input" placeholder="17 символов" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="brandModel">Марка, модель</label>
              <input type="text" id="brandModel" class="field__input" placeholder="напр. Toyota Camry" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="vehicleType">Тип ТС</label>
              <input type="text" id="vehicleType" class="field__input" placeholder="легковой, грузовой…" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="year">Год выпуска</label>
              <input type="text" id="year" class="field__input" placeholder="год" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="engine">Двигатель</label>
              <input type="text" id="engine" class="field__input" placeholder="модель, №" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="chassis">№ шасси (рамы)</label>
              <input type="text" id="chassis" class="field__input" placeholder="—" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="body">№ кузова</label>
              <input type="text" id="body" class="field__input" placeholder="—" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="color">Цвет</label>
              <input type="text" id="color" class="field__input" placeholder="цвет" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="srts">СРТС</label>
              <input type="text" id="srts" class="field__input" placeholder="свидетельство" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="plateNumber">Гос. номер</label>
              <input type="text" id="plateNumber" class="field__input" placeholder="А123БВ77" autocomplete="off">
            </div>
            <div class="field">
              <label class="field__label" for="pts">ПТС</label>
              <input type="text" id="pts" class="field__input" placeholder="№ ПТС" autocomplete="off">
            </div>
          </div>
          <div class="form-section__sub form-section__sub--dkp-single">
            <div class="field">
              <label class="field__label" for="dkpSummary">ДКП</label>
              <input type="text" id="dkpSummary" class="field__input field__input--readonly" placeholder="указывается в блоке «Продавец (для ДКП)»" readonly>
            </div>
          </div>
        </fieldset>

        <fieldset class="form-section">
          <legend class="form-section__title">Документы и оплата</legend>
          <div class="form-row form-row--add-doc">
            <div class="field">
              <label class="field__label" for="docSelect">Добавить документ</label>
              <select id="docSelect" class="field__select">
                <option value="">Выберите документ из списка</option>
                <!-- заполняется из прейскуранта -->
              </select>
            </div>
            <button type="button" class="btn btn--add-doc" id="btnAddDoc">Добавить</button>
          </div>
          <div class="documents-to-print" id="documentsToPrint">
            <p class="documents-to-print__empty" id="documentsEmpty">Документов пока нет — выберите и нажмите «Добавить»</p>
            <ul class="documents-to-print__list" id="documentsList"></ul>
          </div>
          <div class="form-row amounts">
            <div class="field">
              <label class="field__label" for="stateDuty">Госпошлина, ₽</label>
              <input type="number" id="stateDuty" class="field__input field__input--number" min="0" step="1" value="0" placeholder="0">
            </div>
            <div class="field field--plate">
              <div class="plate-option">
                <label class="toggle-label">
                  <input type="checkbox" id="needPlate" class="toggle-label__input" autocomplete="off">
                  <span class="toggle-label__box"></span>
                  <span class="toggle-label__text">Изготовление номера</span>
                </label>
                <span class="plate-option__qty">
                  <select id="plateQuantity" class="field__select field__select--sm" title="Количество">
                    <option value="1">1 шт — 1 500 ₽</option>
                    <option value="2">2 шт — 3 000 ₽</option>
                  </select>
                </span>
              </div>
            </div>
          </div>
        </fieldset>
      </section>

      <!-- Автозаполняемый блок: итоги и действия -->
      <section class="card card--summary" id="summaryCard">
        <h2 class="card__title">Итого и оплата</h2>
        <div class="summary">
          <div class="summary__row">
            <span class="summary__label">Госпошлина</span>
            <span class="summary__value" id="sumStateDuty">0 ₽</span>
          </div>
          <div class="summary__row">
            <span class="summary__label">Доход павильона</span>
            <span class="summary__value summary__value--income" id="sumIncome">0 ₽</span>
          </div>
          <div class="summary__row summary__row--total">
            <span class="summary__label">К оплате</span>
            <span class="summary__value summary__value--total" id="sumTotal">0 ₽</span>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="btn btn--primary" id="btnAcceptCash" disabled>
            Принять наличные
          </button>
          <button type="button" class="btn btn--secondary" id="btnPrint" disabled>
            Печать документов
          </button>
        </div>
        <p class="summary__hint">Сумма считается автоматически из полей выше</p>
      </section>

      <!-- Мини-сводка для печати (заполняется из основной формы) -->
      <section class="card card--preview" id="previewCard">
        <h2 class="card__title">Сводка для документов</h2>
        <div class="preview" id="documentPreview">
          <p class="preview__line"><strong>ФИО:</strong> <span id="previewFio">—</span></p>
          <p class="preview__line"><strong>Паспорт:</strong> <span id="previewPassport">—</span></p>
          <p class="preview__line"><strong>Адрес:</strong> <span id="previewAddress">—</span></p>
          <p class="preview__line"><strong>Телефон:</strong> <span id="previewPhone">—</span></p>
          <p class="preview__line"><strong>Продавец:</strong> <span id="previewSeller">—</span></p>
          <p class="preview__line"><strong>Доверенное лицо:</strong> <span id="previewTrustee">—</span></p>
          <p class="preview__line"><strong>VIN / Марка:</strong> <span id="previewVehicle">—</span></p>
          <p class="preview__line"><strong>ДКП (договор):</strong> <span id="previewDkp">—</span></p>
          <p class="preview__line"><strong>Документы:</strong> <span id="previewService">—</span></p>
          <p class="preview__line"><strong>К оплате:</strong> <span id="previewTotal">0 ₽</span></p>
        </div>
      </section>

      <!-- Список документов для печати = выбранные в блоке «Документы и оплата» -->
      <section class="card card--docs" id="docsCard">
        <h2 class="card__title">Документы для печати</h2>
        <ul class="doc-list" id="docList">
          <li class="doc-list__item doc-list__item--placeholder">Добавьте документы выше — здесь будет тот же список</li>
        </ul>
      </section>
    </main>

    <footer class="footer">
      <span id="orderIdDisplay"></span>
      <span class="footer__time" id="currentTime"></span>
    </footer>
  </div>

  <script src="auth.js"></script>
  <script>
    (function(){
      if (!window.requireAuth()) return;
      var user = window.getUser();
      if (user) {
        var el = document.getElementById('currentUserName');
        if (el) {
          if (user.role === 'ROLE_ADMIN') {
            var a = document.createElement('a');
            a.href = 'account.html';
            a.textContent = user.name;
            a.style.color = 'inherit';
            a.style.textDecoration = 'none';
            el.appendChild(a);
          } else {
            el.textContent = user.name;
          }
        }
      }
      document.getElementById('btnLogout').addEventListener('click', function (e) {
        e.preventDefault();
        window.clearAuth();
        window.location.href = 'login.html';
      });
    })();
  </script>
  <script src="app.js"></script>
</body>
</html>
