<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Вход — Павильоны МРЭО</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=PT+Serif:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .login-card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); padding: 2rem; width: 100%; max-width: 360px; }
    .login-card h1 { font-family: var(--font-serif); margin: 0 0 1.5rem; font-size: 1.5rem; }
    .login-card label { display: block; margin-bottom: 0.35rem; color: var(--text-muted); font-size: 0.9rem; }
    .login-card input { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; margin-bottom: 1rem; box-sizing: border-box; }
    .login-card button { width: 100%; padding: 0.75rem; font-size: 1rem; }
    .login-error { color: #b91c1c; font-size: 0.9rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div class="login-page">
    <div class="login-card">
      <h1>Вход в систему</h1>
      <p style="color: var(--text-muted); margin: 0 0 1.25rem; font-size: 0.9rem;">Павильоны МРЭО</p>
      <div id="loginError" class="login-error" style="display: none;"></div>
      <form id="loginForm" method="post" action="">
        <label for="login">Логин</label>
        <input type="text" id="login" name="username" autocomplete="username" required>
        <label for="password">Пароль</label>
        <input type="password" id="password" name="password" autocomplete="current-password" required>
        <button type="submit" class="btn" id="btnSubmit">Войти</button>
      </form>
    </div>
  </div>
  <script src="auth.js"></script>
  <script>
    (function () {
      if (window.getToken && window.getToken()) {
        window.location.href = 'index.html';
        return;
      }
      var form = document.getElementById('loginForm');
      var errEl = document.getElementById('loginError');
      var btn = document.getElementById('btnSubmit');

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        errEl.style.display = 'none';
        errEl.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Вход…';

        var formData = new FormData();
        formData.append('username', document.getElementById('login').value.trim());
        formData.append('password', document.getElementById('password').value);

        var base = window.API_BASE_URL || '';
        fetch(base + '/auth/login', { method: 'POST', body: formData })
          .then(function (res) {
            if (!res.ok) {
              return res.json().then(function (j) { throw new Error(j.detail || 'Ошибка входа'); }).catch(function () { throw new Error('Ошибка ' + res.status); });
            }
            return res.json();
          })
          .then(function (data) {
            window.setToken(data.access_token, data.user);
            window.location.href = 'index.html';
          })
          .catch(function (err) {
            errEl.textContent = err.message || 'Неверный логин или пароль';
            errEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Войти';
          });
      });
    })();
  </script>
</body>
</html>
